<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>息吹きバルーン対戦</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", YuGothic, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            color: #333;
        }

        #gameContainer {
            width: 100%;
            max-width: 500px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            position: relative;
            background: white;
        }

        #startScreen, #resultScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 40px;
            text-align: center;
        }

        #startScreen h1 {
            font-size: 1.8em;
            margin-bottom: 30px;
            font-weight: 600;
            color: #333;
            letter-spacing: 2px;
        }

        .instructions {
            font-size: 0.95em;
            line-height: 2;
            margin-bottom: 40px;
            text-align: left;
            color: #666;
            max-width: 350px;
            padding: 20px;
            background: #f9f9f9;
            border-left: 3px solid #333;
        }

        .instructions div {
            margin: 8px 0;
        }

        button {
            background: #333;
            color: white;
            border: none;
            padding: 16px 48px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            letter-spacing: 1px;
        }

        button:hover {
            background: #555;
        }

        button:active {
            transform: scale(0.98);
        }

        #opponentArea {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            border-bottom: 1px dashed #ddd;
        }

        #playerArea {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .balloon {
            border-radius: 50%;
            position: relative;
            transition: background-color 0.3s;
            border: 2px solid #333;
        }

        .balloon::after {
            content: '';
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 30px;
            background: #333;
        }

        #playerBalloon {
            background: #4A90E2;
        }

        #opponentBalloon {
            background: #F5A623;
        }

        .hidden {
            display: none !important;
        }

        #stats {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            font-weight: 500;
            color: #999;
            font-family: 'Courier New', monospace;
        }

        #instruction {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.1em;
            color: #666;
            text-align: center;
            padding: 20px;
            background: rgba(255,255,255,0.9);
            border: 1px solid #ddd;
        }

        #battleButton {
            margin-top: 30px;
            padding: 16px 60px;
            font-size: 1.1em;
            background: #E74C3C;
            animation: pulse 2s infinite;
        }

        #battleButton:hover {
            background: #C0392B;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 1; }
        }

        @keyframes shake {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-3px, -3px); }
            20% { transform: translate(3px, 3px); }
            30% { transform: translate(-3px, 3px); }
            40% { transform: translate(3px, -3px); }
            50% { transform: translate(-3px, -3px); }
            60% { transform: translate(3px, 3px); }
            70% { transform: translate(-3px, 3px); }
            80% { transform: translate(3px, -3px); }
            90% { transform: translate(-3px, -3px); }
        }

        .shaking {
            animation: shake 0.3s infinite;
        }

        #coverMask {
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3em;
            color: white;
            border-radius: 50%;
            font-weight: bold;
        }

        #resultScreen h2 {
            font-size: 2em;
            margin-bottom: 20px;
            font-weight: 600;
            color: #333;
        }

        #resultScreen p {
            font-size: 1.1em;
            margin-bottom: 30px;
            color: #666;
            font-family: 'Courier New', monospace;
        }

        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
        }

        #debugInfo {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            font-size: 0.75em;
            font-family: 'Courier New', monospace;
            color: #999;
            text-align: center;
            background: rgba(255,255,255,0.9);
            padding: 8px;
            border-top: 1px solid #ddd;
        }

        .prototype-label {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.7em;
            color: #999;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }

        .note {
            font-size: 0.85em;
            color: #999;
            margin-top: 20px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div class="prototype-label">PROTOTYPE v1.0</div>

        <div id="startScreen">
            <h1>息吹きバルーン対戦</h1>
            <div class="instructions">
                <div>【ゲームルール】</div>
                <div>• マイクに息を吹きかける</div>
                <div>• バルーンが膨らむ</div>
                <div>• 75%を超えると危険状態</div>
                <div>• 100%に達すると破裂</div>
                <div>• 画面タップで対戦開始</div>
                <div>• 大きい方が勝利</div>
            </div>
            <div class="note">※ 周波数解析により息吹きを検出</div>
            <button id="startBtn">スタート</button>
        </div>

        <div id="stats">
            <span id="playerSize">プレイヤー: ???</span>
            <span id="opponentSize">相手: ???</span>
        </div>

        <div id="opponentArea">
            <div id="opponentBalloon" class="balloon hidden" style="width: 80px; height: 80px;">
                <div id="coverMask">?</div>
            </div>
        </div>

        <div id="instruction" class="hidden">
            マイクに向かって息を吹いてください
        </div>

        <div id="playerArea">
            <div id="playerBalloon" class="balloon hidden" style="width: 80px; height: 80px;"></div>
            <button id="battleButton" class="hidden">対戦開始</button>
        </div>

        <div id="debugInfo" class="hidden">
            音量: -- | 低周波: -- | 比率: --
        </div>

        <div id="resultScreen" class="hidden">
            <h2 id="resultTitle"></h2>
            <p id="resultText"></p>
            <button id="restartBtn">もう一度</button>
        </div>
    </div>

    <script>
        let audioContext;
        let analyser;
        let microphone;
        let dataArray;
        let frequencyData;
        let gameState = 'start';
        let playerSize = 0;
        let opponentSize = 0;
        
        const maxSize = 100;
        const dangerThreshold = 75;
        const burstThreshold = 100;

        const startScreen = document.getElementById('startScreen');
        const resultScreen = document.getElementById('resultScreen');
        const startBtn = document.getElementById('startBtn');
        const restartBtn = document.getElementById('restartBtn');
        const playerBalloon = document.getElementById('playerBalloon');
        const opponentBalloon = document.getElementById('opponentBalloon');
        const instruction = document.getElementById('instruction');
        const playerSizeDisplay = document.getElementById('playerSize');
        const opponentSizeDisplay = document.getElementById('opponentSize');
        const coverMask = document.getElementById('coverMask');
        const battleButton = document.getElementById('battleButton');
        const debugInfo = document.getElementById('debugInfo');
        const gameContainer = document.getElementById('gameContainer');

        startBtn.addEventListener('click', initGame);
        restartBtn.addEventListener('click', resetGame);
        battleButton.addEventListener('click', handleBattle);

        async function initGame() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.3;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                frequencyData = new Uint8Array(bufferLength);
                
                microphone.connect(analyser);
                
                startScreen.classList.add('hidden');
                playerBalloon.classList.remove('hidden');
                opponentBalloon.classList.remove('hidden');
                instruction.classList.remove('hidden');
                battleButton.classList.remove('hidden');
                debugInfo.classList.remove('hidden');
                
                gameState = 'blowing';
                opponentSize = Math.floor(Math.random() * 36) + 60;
                updateGame();
            } catch (err) {
                alert('マイクの許可が必要です。\n\nブラウザの設定でマイクを許可してください。');
            }
        }

        function detectBlowing() {
            analyser.getByteTimeDomainData(dataArray);
            analyser.getByteFrequencyData(frequencyData);
            
            const volume = dataArray.reduce((a, b) => a + Math.abs(b - 128)) / dataArray.length;
            
            // 低周波エネルギー分析 (0-500Hz)
            const lowFreqEnergy = frequencyData.slice(0, 20).reduce((a, b) => a + b) / 20;
            const midFreqEnergy = frequencyData.slice(20, 80).reduce((a, b) => a + b) / 60;
            const ratio = lowFreqEnergy / (midFreqEnergy + 1);
            
            debugInfo.textContent = `音量: ${volume.toFixed(1)} | 低周波: ${lowFreqEnergy.toFixed(1)} | 比率: ${ratio.toFixed(2)}`;
            
            // 息吹き特徴: 低周波エネルギーが高く、音量が適度
            return volume > 15 && volume < 80 && ratio > 1.2;
        }

        function updateGame() {
            if (gameState !== 'blowing') return;

            const blowingDetected = detectBlowing();
            
            if (blowingDetected) {
                playerSize += 0.8;
                playerSize = Math.min(playerSize, burstThreshold);
            }

            updateBalloonAppearance();
            
            if (playerSize >= burstThreshold) {
                burstBalloon();
                return;
            }

            requestAnimationFrame(updateGame);
        }

        function updateBalloonAppearance() {
            const size = 80 + (playerSize * 2.2);
            playerBalloon.style.width = size + 'px';
            playerBalloon.style.height = size + 'px';
            playerSizeDisplay.textContent = `プレイヤー: ???`;

            if (playerSize >= dangerThreshold) {
                const danger = (playerSize - dangerThreshold) / (burstThreshold - dangerThreshold);
                const baseR = 74, baseG = 144, baseB = 226; // #4A90E2
                const targetR = 231, targetG = 76, targetB = 60; // #E74C3C
                
                const r = Math.floor(baseR + (targetR - baseR) * danger);
                const g = Math.floor(baseG + (targetG - baseG) * danger);
                const b = Math.floor(baseB + (targetB - baseB) * danger);
                
                playerBalloon.style.background = `rgb(${r}, ${g}, ${b})`;
                
                if (!playerBalloon.classList.contains('shaking')) {
                    playerBalloon.classList.add('shaking');
                }
            } else {
                playerBalloon.style.background = '#4A90E2';
                playerBalloon.classList.remove('shaking');
            }
        }

        function handleBattle() {
            if (gameState !== 'blowing' || playerSize < 10) return;
            
            gameState = 'battle';
            instruction.classList.add('hidden');
            battleButton.classList.add('hidden');
            
            coverMask.classList.add('hidden');
            const opponentSizePx = 80 + (opponentSize * 2.2);
            opponentBalloon.style.width = opponentSizePx + 'px';
            opponentBalloon.style.height = opponentSizePx + 'px';
            opponentSizeDisplay.textContent = `相手: ${Math.floor(opponentSize)}%`;

            setTimeout(() => {
                determineWinner();
            }, 1000);
        }

        function determineWinner() {
            let resultTitle, resultText;
            
            if (playerSize > opponentSize) {
                resultTitle = '勝利';
                resultText = `プレイヤー ${Math.floor(playerSize)}% vs 相手 ${Math.floor(opponentSize)}%`;
            } else if (playerSize < opponentSize) {
                resultTitle = '敗北';
                resultText = `プレイヤー ${Math.floor(playerSize)}% vs 相手 ${Math.floor(opponentSize)}%`;
            } else {
                resultTitle = '引き分け';
                resultText = `両者 ${Math.floor(playerSize)}%`;
            }

            document.getElementById('resultTitle').textContent = resultTitle;
            document.getElementById('resultText').textContent = resultText;
            resultScreen.classList.remove('hidden');
            gameState = 'end';
        }

        function burstBalloon() {
            gameState = 'end';
            createExplosion(playerBalloon);
            playerBalloon.style.display = 'none';
            instruction.classList.add('hidden');
            battleButton.classList.add('hidden');
            
            setTimeout(() => {
                document.getElementById('resultTitle').textContent = '破裂';
                document.getElementById('resultText').textContent = `${Math.floor(playerSize)}% で破裂しました`;
                resultScreen.classList.remove('hidden');
            }, 500);
        }

        function createExplosion(element) {
            const rect = element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = centerX + 'px';
                particle.style.top = centerY + 'px';
                particle.style.background = '#4A90E2';
                document.body.appendChild(particle);

                const angle = (Math.PI * 2 * i) / 20;
                const velocity = 5 + Math.random() * 5;
                const vx = Math.cos(angle) * velocity;
                const vy = Math.sin(angle) * velocity;

                animateParticle(particle, vx, vy);
            }
        }

        function animateParticle(particle, vx, vy) {
            let x = parseFloat(particle.style.left);
            let y = parseFloat(particle.style.top);
            let opacity = 1;

            function update() {
                x += vx;
                y += vy;
                opacity -= 0.02;
                
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.opacity = opacity;

                if (opacity > 0) {
                    requestAnimationFrame(update);
                } else {
                    particle.remove();
                }
            }
            update();
        }

        function resetGame() {
            playerSize = 0;
            opponentSize = Math.floor(Math.random() * 36) + 60;
            gameState = 'blowing';
            
            resultScreen.classList.add('hidden');
            playerBalloon.style.display = 'block';
            playerBalloon.classList.remove('shaking');
            playerBalloon.style.width = '80px';
            playerBalloon.style.height = '80px';
            playerBalloon.style.background = '#4A90E2';
            
            opponentBalloon.style.width = '80px';
            opponentBalloon.style.height = '80px';
            coverMask.classList.remove('hidden');
            
            instruction.classList.remove('hidden');
            battleButton.classList.remove('hidden');
            playerSizeDisplay.textContent = 'プレイヤー: ???';
            opponentSizeDisplay.textContent = '相手: ???';
            
            updateGame();
        }
    </script>
</body>
</html>
